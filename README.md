# hse_spark_course

## Cодержание
- [MapReduce. Введение в распределенные вычисления](#t1)
- [Apache Spark. RDD](#t2)
- [Финальный проект](#finpro)


## Инфраструктура курса

- [Локальный кластре на Docker](https://github.com/NameArtem/hadoop-spark-standalone-docker)
- [DataBricks Community](/tutorials/databricks_tutorial)

## План курса

|№|Тема занятия| Статус| Дата | Ссылка|
|:---:|:---:|:---:|:---:|:---:|
|1| MapReduce. Введение в распределенные вычисления |Готово |27.02.2021||
|2| HDFS. Apache Spark (RDD) (+ FuncProg на Python) |Готово |06.03.2021||
|3| Spark SQL. Анализ больших данных |Готово (загрузить)|13.03.2021||
|4| Подробнее о модели вычислений Spark. Знакомство со Scala |Готово (загрузить)|20.03.2021||
|5| Spark ML |Готово (загрузить)|27.03.2021||
|6| Рекомендательные системы на Spark |Готово (загрузить)|03.04.2021||
|7| Spark Structure Streaming (+ интеграция со Spark ML) |Готово (загрузить)|10.04.2021||
|8| Модели в прод. Управленеи кластеровм  |Готово (загрузить)|17.04.2021||


## MapReduce. Введение в распределенные вычисления
<a href='t1'></a>

[презентация](https://github.com/NameArtem/hse_spark_course/tree/master/pres)

[учебный материал](https://github.com/NameArtem/hse_spark_course/tree/master/classwork/d1)

[домашнее задание](https://github.com/NameArtem/hse_spark_course/tree/master/homework/hw_1)


## Apache Spark. RDD
<a href='t2'></a>

[презентация](https://github.com/NameArtem/hse_spark_course/tree/master/pres)

[учебный материал](https://github.com/NameArtem/hse_spark_course/tree/master/classwork/d2)





## Финальный проект
<a href='finpro'></a>


Данные для финального проекта:

- Заголовки новостей с Reddit ([данные](https://github.com/NameArtem/hse_spark_course/tree/master/project/data
- Скачать индекс [DJI](https://ru.investing.com/indices/us-30)
- Скачать данные по акциям (выбрать 3 любые компании) из состава индекса DJI([структура индекса](https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%BE%D0%BC%D1%8B%D1%88%D0%BB%D0%B5%D0%BD%D0%BD%D1%8B%D0%B9_%D0%B8%D0%BD%D0%B4%D0%B5%D0%BA%D1%81_%D0%94%D0%BE%D1%83_%D0%94%D0%B6%D0%BE%D0%BD%D1%81%D0%B0))
- Скачать данные по акциям (выбрать 2 любые компании), которые не входят в индекс DJI



<p align="center"><img src="img/project_1.jpg"></p>

### Задачи реализуемые на RDD

<p align="center"><img src="img/project_1_t1.jpg"></p>

**Подсказки**

1. Скользящее среднее (и экспоненциальное скользящее среднее). Это функция `sliding`, её нужно реализовать самостоятельно

```python
# создайте функцию, которая будет брать окно по данным
def window(xi, n):
  # n - это размер окна
  # xi - это кортеж из заначения и индекса
  x, i = xi
  return [(i - offset, (i, x)) for offset in range(n)]

# примените к объекту RDD

new_rdd = rdd\
            .zipWithIndex()\ # добавляем индекс к объекту
            .flatMap(lambda xi: gen_window(xi, n))\ # создаем пары для окна
            .groupByKey()\ # создаем окно в данных
            .mapValues(lambda vals: [x for (i, x) in sorted(vals)])\ # применяем сортировку для исправления последовательности
            .sortByKey()\ # сортируюм по ключу, чтобы согласовать с прошлым шагом
            .values()\
            .filter(lambda x: len(x) == n)) # удаляем лишнее

```
----------------------------------

2. Расчет RSI (индикатор, который измеряет соотношение восходящи и нисходящих движений, нормализованный от 0 до 100). **Как понимать:** Данный индикатор отображает «моментум» - скорость и амплитуду, с которой изменяется движение цены; насколько сильно изменяется цена в сторону своего движения. Иными словами, индикатор RSI показывает силу тренда и вероятность его смены.

 - чем сильнее относительное движение цены вверх(больше суммарная длина зеленых свечей за определенный период), то тем ближе значение индикатора к 100;
 - чем сильнее относительное движение цены вниз(больше суммарная длина красных свечей за определенный период), то тем ближе значение индикатора к 0


```
# формула расчета
# Шаг 1
# RS = средняя цена положительного закрытия / средняя цена отрицательного закрытия    (за период, обычно 3, 12 bkb 50)

# Шаг 2
# RSI = 100 - 100 / (1 + RS)
```

**Note:** рассмотрите методы `mapPartitions`. [Документации](https://spark.apache.org/docs/2.1.0/api/python/pyspark.html?highlight=mappartitions#pyspark.RDD.mapPartitionsWithIndex)

```python
def func(iterator):
  return [x * 100 for x in iterator]

rdd = sc.parallelize([1, 2, 3, 4])

rdd.mapPartitions(func).collect()
```

----------------------------------
3. Расчет `стохастического осциллятора / stochastic oscillator` — индикатор технического анализа, который показывает положение текущей цены относительно диапазона цен за определенный период в прошлом. В %.

 Понимание:
 - индикатор к покупке, когда осциллятор (%K или %D) сначала опустится ниже определенного уровня (обычно 20), а затем поднимется выше него;
 - индикатор к продаже, когда осциллятор сначала поднимется выше определенного уровня (обычно 80), а потом опустится ниже него;
 - индикатор к покупке, если линия %K поднимается выше линии %D;
 - индткатор к продаже, если линия %K опускается ниже линии %D.

```
# формула расчета

# данные
# CLOSE — сегодняшняя цена закрытия;
# MIN (LOW (%K)) — наименьший минимум за число периодов %K;
# MAX (HIGH (%K)) — наибольший максимум за число периодов %K.
# Периоды %K. Это число единичных периодов, используемых для расчета стохастического осциллятора.
# Периоды замедления %K. Эта величина определяет степень внутренней сглаженности линии %K. Значение 1 дает быстрый стохастический осциллятор, а значение 3 — медленный. (устанавливайте его на основе скользящего среднего)
# Периоды %D. Это число единичных периодов, используемых для расчета скользящего среднего линии %K.
# Метод %D. Это метод сглаживания (экспоненциальный, простой, сглаженный или взвешенный), используемый при расчете %D. (у нас всегда экспоненциальный)


# %K = (CLOSE - MIN (LOW (%K))) / (MAX (HIGH (%K)) - MIN (LOW (%K))) * 100

```

----------------------------------
4. Расчет `On Balance Volume (OBV)` - трендовый индикатор, рассчитываемый по данным объема торгов. Считается, что если текущая цена закрытия периода выше, чем предыдущая, то объем прибавляется к значению индикатора On Balance Volume. Если текущая цена закрытия ниже предыдущей, то данные объема вычитаются из индикатора

 Чтобы понять, как рассчитывается значение On Balance Volume, следует отобразить график объема торгов (Volume) под графиком цены в форме гистограммы (график объема торгов выводится по умолчанию сразу вместе с ценовым графиком).

 В качестве примера рассмотрим рисунок:

 <p align="center"><img src="img/obv1.jpg"></p>

  Последняя свеча на нем является растущей, и цена ее закрытия находится выше закрытия предыдущей свечи, поэтому текущий объем торгов (27806) будет прибавлен к показателю On Balance Volume и логически зачислен к объемам быков, показывая, что они у руля. При этом линия OBV растет. Если закрытие ценовой свечи было бы ниже предыдущей, то указанный объем вычитался бы из показателя OBV и приписывался к объему медведей, показывая, что именно они доминируют в текущий момент. При этом линия OBV снижалась бы на указанное значение объема. А если бы текущее значение цены было равно предыдущему, то OBV оставался без изменений, показывая, что на рынке нет лидирующей группы. То есть если On Balance Volume растет, то доминируют быки, если снижается — лидируют медведи, если не изменяется — на рынке нет победителя, и цена стоит на месте.

  **растущая свеча** - цена закрытия больше цены открытия

  **падающая свеча** - цена закрытия ниже цены открытия (больше о свечах на [сайте Московской бирже](https://place.moex.com/useful/yaponskie-svechi-dlya-nachinayushih))

  Рассмотрим на реальном графике:

  <p align="center"><img src="img/obv.jpg"></p>

 **! Note:** подумайте, как это расчитать. В этом показателе нет плавающих оконо, но вам нужно в rdd добавить дополнительные "колонки"

----------------------------------

5. Расчет `MACD / Moving Average Convergence/Divergence` — это индикатор, показывает не только усредненный консенсус масс, но и отражает согласованность долгосрочной и краткосрочной тенденций. Индикатор MACD представляет собой комбинацию из трех скользящих средних. Одна, более быстрая (отражает краткосрочную тенденцию), называется «линией MACD», другая, более медленная (отражает долгосрочную тенденцию), — «сигнальной линией MACD». Периоды - 12 и 26, для быстрого и медленного значения.

 Рассмотрим на реальном графике:

 <p align="center"><img src="img/macd.jpg"></p>

 Для построения данного индикатора необходимо взять экспоненциальное скользящее среднее (ЕМА) от цен закрытия с периодом усреднения 12. После от тех же цен закрытия следует вычислить еще одну ЕМА с периодом усреднения 26. Следующий шаг — вычесть из 12 ЕМА (оно будет больше, чем 26, в растущем тренде и меньше — в падающем) 26 ЕМА. Собственно, начертание этой разницы и образует быструю линию MACD. Для начертания сигнальной линии MACD следует вычислить ЕМА с периодом усреднения 9 от линии MACD (полученной разницы между 12 и 26 ЕМА). Таким образом получается индикатор, представляющий из себя две линии, периодически переплетающиеся между собой. Как раз 12, 26 и 9 являются стандартными параметрами ЕМА для построения индикатора MACD.
